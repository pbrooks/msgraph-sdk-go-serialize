# Test Case to demonstrate defect in hierarchy call order for msgraph serialization

When using the [Microsot Graph SDK for go](https://github.com/microsoftgraph/msgraph-sdk-go), invalid JSON can be generated by the user.

## Test Run

	go test -v -race ./... 
	=== RUN   TestSerialization
		serialization_test.go:60: 
				Error Trace:	serialization_test.go:60
				Error:	  	Not equal: 
								expected: "{\"id\":\"test_id\",\"description\":\"test_desc\",\"targetTypes\":[\"Device\"]}"
								actual  : "{\"id\":\"test_id\"\"description\":\"test_desc\",\"targetTypes\":[\"Device\"]}"
								
								Diff:
								--- Expected
								+++ Actual
								@@ -1 +1 @@
								-{"id":"test_id","description":"test_desc","targetTypes":["Device"]}
								+{"id":"test_id""description":"test_desc","targetTypes":["Device"]}
				Test:	   	TestSerialization
				Messages:   	Expected JSON matches output
	Content  {"id":"test_id""description":"test_desc","targetTypes":["Device"]}
	--- FAIL: TestSerialization (0.00s)
	=== RUN   TestSerialization_Mitigation
	Content  {"id":"test_id","description":"test_desc","targetTypes":["Device"]}
	--- PASS: TestSerialization_Mitigation (0.00s)
	FAIL
	FAIL	github.com/pbrooks/msgraph-sdk-go-serialize	0.024s
	FAIL
	make: *** [Makefile:45: test] Error 1
	‚ùØ make test


## Callstack 

[schema_extension.go#L135](https://github.com/microsoftgraph/msgraph-sdk-go/blob/4f19d8655dce2644515f3283dde12f84134dc8f5/models/microsoft/graph/schema_extension.go#L135)

	func (m *SchemaExtension) Serialize(writer i04eb5309aeaafadd28374d79c8471df9b267510b4dc2e3144c378c50f6fd7b55.SerializationWriter)(error) {
		err := m.Entity.Serialize(writer)                                  *
		if err != nil {
			return err
		}
		{
			err = writer.WriteStringValue("description", m.GetDescription())
			if err != nil {
				return err
			}
		}

		// Code removed for breviety
	}

[entity.go#L56](https://github.com/microsoftgraph/msgraph-sdk-go/blob/4f19d8655dce2644515f3283dde12f84134dc8f5/models/microsoft/graph/entity.go#L56)

	func (m *Entity) Serialize(writer i04eb5309aeaafadd28374d79c8471df9b267510b4dc2e3144c378c50f6fd7b55.SerializationWriter)(error) {
		{
			err := writer.WriteStringValue("id", m.GetId())
			if err != nil {
				return err
			}
		}
		{
			err := writer.WriteAdditionalData(m.GetAdditionalData())        *
			if err != nil {
				return err
			}
		}
		return nil
	}

[json_serialization_writer.go#L557](https://github.com/microsoft/kiota/blob/ce9fb06a3e34fa0a2d542e78a7cd276b6a975749/serialization/go/json/json_serialization_writer.go#L557)

	func (w *JsonSerializationWriter) WriteAdditionalData(value map[string]interface{}) error {
		if value != nil {
			for key, value := range value {
				p, ok := value.(absser.Parsable)

				// Cases, removed for breviety

			}
			w.trimLastPropertySeparator()                                   *
		}
		return nil
	}

## Explination

Serialization within SchemaExtension will call the parent serializer.
Entity.Serialize will output a kvp and prepend a comma delimiter.

The WriteAdditionalData function will be called, adding no output.
However, this function will trim any last property function from the writer.

When execution returns to write the SchemaExtension data, there will be a missing delimter.
Invalid JSON is produced and rejected by the graph API.

## Mitigations

The pattern of calling the parent serializer, is a clear design choice through the code.

Mitigation 1 - Re-work call order, to have additional data always execute at the end.

Mitigation 2 - Ensure graph construction of models (i.e NewSchemaExtension) always nil AdditionalData)

Mitigation 3 - User error, the user is implementing the API incorrectly.

A sample case TestSerialization_Mitigation is provided, where AdditionalData is explicitly set to nil.

